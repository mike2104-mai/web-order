<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TMFood-Menu</title>
    <link rel="stylesheet" href="menu_style.css" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header>
      <h1 class="logo">TMFood</h1>
      <nav>
        <ul>
          <li>
            <a href="trang_chu.html"><i class="fas fa-home"></i> Trang ch·ªß</a>
          </li>
          <li>
            <a href="final_menu.html" class="active"
              ><i class="fas fa-th"></i> Menu</a
            >
          </li>
          <li id="cart_tab">
            <a href="gio_hang.html"
              ><i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng
              <span id="cart-count">(0)</span></a
            >
          </li>
          <li>
            <a href="don_hang.html" class=""
              ><i class="fas fa-receipt"></i> ƒê∆°n h√†ng c·ªßa t√¥i</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <aside class="sidebar">
        <ul class="category-list">
          <!-- Categories will be dynamically loaded here -->
        </ul>
      </aside>

      <main>
        <div class="category-food-section">
          <button class="btn-category">T·∫•t c·∫£</button>
          <div class="food-grid">
            <!-- Food items remain the same -->

            <!-- Other food items with same structure -->
          </div>
        </div>
      </main>
    </div>

    <script>
      const backendURL = "http://localhost:8080/api";
      const categoryElement = document.querySelector(".category-food-section");
      const categoryList = document.querySelector(".category-list");
      const foodGrid = document.querySelector(".food-grid");
      //Gi·ªè h√†ng
      const basketItems =
        JSON.parse(sessionStorage.getItem("basketItems")) || [];

      function handleClickCategory() {
        // Th√™m s·ª± ki·ªán click v√†o danh m·ª•c
        const categoryElements = document.querySelectorAll(".category");
        categoryElements.forEach((category) => {
          category.addEventListener("click", async function () {
            categoryElements.forEach((c) => c.classList.remove("active"));
            this.classList.add("active");

            const selectedCategory = this.getAttribute("data-category");
            if (selectedCategory === "all") {
              await fetchAllCategoryFood();
              return;
            } else {
              // G·ªçi h√†m fetchCategoryItems v·ªõi ID danh m·ª•c ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ hi·ªÉn th·ªã m√≥n ƒÉn t∆∞∆°ng ·ª©ng v·ªõi danh m·ª•c
              await fetchCategoryItems(selectedCategory);
            }
          });
        });
      }

      //Function fetch food items by category
      async function fetchCategoryItems(categoryId) {
        try {
          let response = await fetch(
            `http://localhost:8080/api/categories/${categoryId}`
          );
          response = await response.json();
          let category = response.data;
          let html = "";
          let foodList = category.Foods;
          html += renderFoodSection(foodList, category.name);
          categoryElement.innerHTML = html;
          const addBtn = document.querySelectorAll(".add-btn");
          addBtn.forEach((btn) => {
            btn.addEventListener("click", function () {
              const foodItem = this.closest(".food-item");
              const foodId = foodItem.getAttribute("data-id");
              const foodName = foodItem.querySelector("p").textContent;
              const foodPrice = parseFloat(
                foodItem.querySelector(".price").textContent.replace("ƒë", "")
              );
              const foodImage = foodItem.querySelector("img").src;
              const quantity = 1;
              const food = {
                id: foodId,
                name: foodName,
                price: foodPrice,
                image: foodImage,
                quantity: quantity,
              };
              handleAddToCart(food);
            });
          });
        } catch (error) {
          console.error("Error fetching category items:", error);
        }
      }

      function renderFoodSection(foodList, categoryName) {
        return `
              <div style="width: 100%">
                  <button class="btn-category">${categoryName}</button>
                  <div class="food-grid">
                      ${(() => {
                        let array = [];
                        foodList.forEach((food) => {
                          array.push(`
                                  <div class="food-item" data-id="${food.id}">
                                    <div class="food-item__image" >
                                      <img src="${food.image}" alt="${
                            food.name
                          }">
                                    </div>
                                    
                                      <p>${food.name}</p>
                                      <span class="price">${food.price} ƒë</span>
                                      <div class="btn-group">
                                        ${(() => {
                                          const item = basketItems.find(
                                            (item) => item.id == food.id
                                          );
                                          if (item) {
                                            return `<div class="quantity-controls" >
                                                <button title="Gi·∫£m" class="quantity-btn minus" onclick="handleQuantityChange(${item.id}, 'decrease')">
                                                    -
                                                </button>
                                                <span class="quantity-number">${item.quantity}</span>
                                                <button title="TƒÉng" class="quantity-btn plus" onclick="handleQuantityChange(${item.id}, 'increase')">
                                                    +
                                                </button>
                                            </div>`;
                                          }

                                          return `<button title="Th√™m v√†o gi·ªè h√†ng" class="add-btn" >Th√™m v√†o gi·ªè h√†ng </button>`;
                                        })()}

                                      </div>
                                  </div>
                              `);
                        });
                        return array.join("");
                      })()}

                  </div>
              </div>`;
      }

      //Function fetch all food items
      async function fetchAllCategoryFood() {
        try {
          let response = await fetch(`${backendURL}/categories`);
          response = await response.json();
          response = response.data;

          //Th√™m danh m·ª•c t·∫•t c·∫£ v√†o sidebar
          categoryList.innerHTML = `
                        <li class="category active" data-category="all">T·∫•t c·∫£</li>
                        <hr>
                    `;
          // HI·ªán th·ªã s·∫£n ph·∫©m theo danh m·ª•c
          let html = "";
          response.forEach((category) => {
            //L·∫•y ra danh s√°ch m√≥n ƒÉn theo danh m·ª•c
            let foodList = category.Foods;
            //Render ƒëo·∫°n html ch·ª©a danh s√°ch m√≥n ƒÉn theo danh m·ª•c
            html += renderFoodSection(foodList, category.name);
            //Hi·ªÉn th·ªã danh s√°ch m√≥n ƒÉn theo danh m·ª•c
            categoryElement.innerHTML = html;

            //Th√™m danh m·ª•c v√†o sidebar
            categoryList.innerHTML += `
                            <li class="category" data-category="${category.id}">${category.name}</li>
                            <hr>
                        `;
            const categorySelect = document.getElementById("itemCategory");
            if (categorySelect) {
              categorySelect.innerHTML += `
                                <option value="${category.id}">${category.name}</option>
                            `;
            }
          });
          //Th√™m s·ª± ki·ªán click v√†o button "Th√™m v√†o gi·ªè h√†ng"
          const addBtn = document.querySelectorAll(".add-btn");
          addBtn.forEach((btn) => {
            btn.addEventListener("click", function () {
              const foodItem = this.closest(".food-item");
              const foodId = foodItem.getAttribute("data-id");
              const foodName = foodItem.querySelector("p").textContent;
              const foodPrice = parseFloat(
                foodItem.querySelector(".price").textContent.replace("ƒë", "")
              );
              const foodImage = foodItem.querySelector("img").src;
              const quantity = 1;
              const food = {
                id: foodId,
                name: foodName,
                price: foodPrice,
                image: foodImage,
                quantity: quantity,
              };
              handleAddToCart(food);
            });
          });
          //Th√™m s·ª± ki·ªán click v√†o danh m·ª•c
          handleClickCategory();
        } catch (error) {
          console.error("Error fetching category items:", error);
        }
      }

      function handleQuantityChange(id, action) {
        const itemIndex = basketItems.findIndex((item) => item.id == id);
        if (itemIndex !== -1) {
          if (action === "increase") {
            basketItems[itemIndex].quantity += 1;
            // C·∫≠p nh·∫≠t quantity
            const quantityElement = document
              .querySelector(
                `[onclick="handleQuantityChange(${id}, 'decrease')"]`
              )
              .parentElement.querySelector(".quantity-number");

            quantityElement.textContent = basketItems[itemIndex].quantity;
          } else if (action === "decrease") {
            basketItems[itemIndex].quantity -= 1;
            // N·∫øu s·ªë l∆∞·ª£ng v·ªÅ 0 th√¨ y√™u c·∫ßu ng∆∞·ªùi d√πng x√°c nh·∫≠n tr∆∞·ªõc khi x√≥a kh·ªèi gi·ªè h√†ng
            if (basketItems[itemIndex].quantity === 0) {
              const confirmDelete = confirm(
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng?"
              );
              if (!confirmDelete) {
                // N·∫øu ng∆∞·ªùi d√πng kh√¥ng x√°c nh·∫≠n, kh√¥i ph·ª•c s·ªë l∆∞·ª£ng v·ªÅ 1
                basketItems[itemIndex].quantity = 1;
                sessionStorage.setItem(
                  "basketItems",
                  JSON.stringify(basketItems)
                );
              } else {
                //N·∫øu ng∆∞·ªùi d√πng x√°c nh·∫≠n th√¨ Render l·∫°i button "Th√™m v√†o gi·ªè h√†ng"
                const foodItem = document.querySelector(`[data-id="${id}"]`);
                const foodName = foodItem.querySelector("p").textContent;
                const foodPrice = parseFloat(
                  foodItem.querySelector(".price").textContent.replace("ƒë", "")
                );
                const foodImage = foodItem.querySelector("img").src;
                const quantity = 1;
                const food = {
                  id: id,
                  name: foodName,
                  price: foodPrice,
                  image: foodImage,
                  quantity: quantity,
                };
                const btnGroup = foodItem.querySelector(".btn-group");
                btnGroup.innerHTML = `<button title="Th√™m v√†o gi·ªè h√†ng" class="add-btn" id="addBtn_${itemIndex}">Th√™m v√†o gi·ªè h√†ng</button>`;
                document
                  .getElementById(`addBtn_${itemIndex}`)
                  .addEventListener("click", function () {
                    handleAddToCart(food);
                  });
                basketItems.splice(itemIndex, 1);
              }
            } else {
              // C·∫≠p nh·∫≠t quantity
              const quantityElement = document
                .querySelector(
                  `[onclick="handleQuantityChange(${id}, 'decrease')"]`
                )
                .parentElement.querySelector(".quantity-number");
              quantityElement.textContent = basketItems[itemIndex].quantity;
            }
          }

          // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã tr√™n tab gi·ªè h√†ng
          const cartCount = document.querySelector("#cart-count");
          if (cartCount) {
            cartCount.textContent = `(${basketItems.length})`;
          }
          // C·∫≠p nh·∫≠t sessionStorage
          sessionStorage.setItem("basketItems", JSON.stringify(basketItems));
          //C·∫≠p nh·∫≠t footer gi·ªè h√†ng v√† render footer
          updateOrderBar(basketItems);
        }
      }

      function handleAddToCart(food) {
        const foodItem = document.querySelector(`[data-id="${food.id}"]`);

        const btnGroup = foodItem.querySelector(".btn-group");
        btnGroup.innerHTML = `<div class="quantity-controls" >
                                    <button title="Gi·∫£m" class="quantity-btn minus" onclick="handleQuantityChange(${food.id}, 'decrease')">
                                      -
                                    </button>
                                    <span class="quantity-number">1</span>
                                    <button title="TƒÉng" class="quantity-btn plus" onclick="handleQuantityChange(${food.id}, 'increase')">
                                      +
                                    </button>
                                </div>`;
        const foodId = food.id;
        const foodName = food.name;
        const foodPrice = parseFloat(food.price);
        const foodImage = food.image;
        const quantity = 1;
        const orderItem = {
          id: foodId,
          name: foodName,
          price: foodPrice,
          image: foodImage,
          quantity: quantity,
        };

        const existingItemIndex = basketItems.findIndex(
          (item) => item.name === orderItem.name
        );
        if (existingItemIndex !== -1) {
          basketItems[existingItemIndex].quantity += quantity;
        } else {
          basketItems.push(orderItem);
        }
        //C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã tr√™n tab gi·ªè h√†ng
        const cart_count = document.querySelector("#cart-count");
        cart_count.textContent = `(${basketItems.length})`;
        //C·∫≠p nh·∫≠t OrderBar
        updateOrderBar(basketItems);
      }

      //C·∫≠p nh·∫≠t footer gi·ªè h√†ng v√† render footer
      function updateOrderBar(basketItems) {
        //C·∫≠p nh·∫≠t gi·ªè h√†ng
        let footer = document.querySelector(".bottom-order-bar");
        sessionStorage.setItem("basketItems", JSON.stringify(basketItems));
        if (basketItems.length === 0) {
          if (footer) document.body.removeChild(footer);
          return;
        }
        if (!footer) {
          footer = document.createElement("div");
          footer.className = "bottom-order-bar";
          footer.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    background: #fff;
                    border-top: 2px solid #e91e63;
                    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                    padding: 12px 20px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-family: Arial, sans-serif;
                    z-index: 9999;
                `;
          document.body.appendChild(footer);
        }

        const total = basketItems.reduce(
          (sum, i) => sum + i.price * i.quantity,
          0
        );
        const itemList = basketItems
          .map((item) => `${item.name} x${item.quantity}`)
          .join(", ");

        footer.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 500; color: #333;">üßæ ${itemList}</div>
                    <div style="margin-top: 5px; color: #e91e63; font-weight: bold;">T·ªïng ti·ªÅn: ${parseFloat(
                      total
                    ).toLocaleString("vi-VN")}‚Ç´</div>
                </div>
                <a href="gio_hang.html" id="confirm-btn" style="
                    padding: 10px 20px;
                    background-color: #e91e63;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: background 0.3s;
                ">ƒêi t·ªõi gi·ªè h√†ng</a>
            `;
      }

      document.addEventListener("DOMContentLoaded", async function () {
        let cart_count = document.querySelector("#cart-count");
        if (!cart_count) {
          cart_count = document.createElement("span");
          cart_count.id = "cart-count";
          document.querySelector(".cart_tab").appendChild(cart_count);
        }
        cart_count.textContent = `(${basketItems.length})`;

        const categoryList = document.querySelector(".category-list");
        const categorySelect = document.getElementById("itemCategory");
        const btnCategory = document.querySelector(".btn-category");

        //G·ªçi h√†m hi·ªÉn th·ªã footer gi·ªè h√†ng
        updateOrderBar(basketItems);

        // T·∫£i t·∫•t c·∫£ danh m·ª•c v√† m√≥n ƒÉn khi trang ƒë∆∞·ª£c t·∫£i
        await fetchAllCategoryFood();

        // X·ª≠ l√Ω s·ª± ki·ªán khi b·∫•m n√∫t "Th√™m v√†o gi·ªè h√†ng"
        const addBtn = document.querySelectorAll(".add-btn");
        addBtn.forEach((btn) => {
          btn.addEventListener("click", function () {
            const foodItem = this.closest(".food-item");
            const foodId = foodItem.getAttribute("data-id");
            const foodName = foodItem.querySelector("p").textContent;
            const foodPrice = parseFloat(
              foodItem.querySelector(".price").textContent.replace("ƒë", "")
            );
            const foodImage = foodItem.querySelector("img").src;
            const quantity = 1;
            const food = {
              id: foodId,
              name: foodName,
              price: foodPrice,
              image: foodImage,
              quantity: quantity,
            };
            handleAddToCart(food);
          });
        });
      });
    </script>
  </body>
</html>
